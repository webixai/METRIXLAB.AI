'use client';

import { motion } from 'framer-motion';
import { X } from 'lucide-react';
import { useEffect, useMemo } from 'react';
import { useEditorStore } from '@/store/useEditorStore';
import { useUser } from '@clerk/nextjs';

interface Props {
  onClose: () => void;
}

// ✅ You can dynamically load fonts from your imported font list
// Example: store all imported font names in an array in a utils file, or inline like this:
const importedFonts = [
  'Beckan', 'Narnia', 'Bropella', 'Ardent', 'Titan One', 'Rammetto One',
  'Bethany Elingston', 'Vanilla Ravioli', 'Liber', 'Rakkas', 'Roboto',
  'Montserrat', 'Playfair Display', 'Lora', 'Inter', 'Poppins', 'Open Sans',
  'Raleway', 'Nunito', 'Caveat', 'Bebas Neue', 'Manrope', 'Satoshi',
  'Quicksand', 'Karla', 'DM Sans', 'Josefin Sans', 'Work Sans',
  'Outfit', 'Orbitron', 'Space Grotesk', 'Cabinet Grotesk',
  // ... (add the rest here)
];

export default function EditPanel({ onClose }: Props) {
  const { user, isLoaded } = useUser();

  const plan = user?.publicMetadata?.plan || 'free';
  const isPremium = plan === 'premium';

  const {
    backgroundColor,
    textColor,
    accentColor,
    fontFamily,
    padding,
    spacing,
    setBackgroundColor,
    setTextColor,
    setAccentColor,
    setFontFamily,
    setPadding,
    setSpacing,
    hydrateFromMetadata,
  } = useEditorStore();

  // ✅ Restore saved user preferences automatically on login
  useEffect(() => {
    if (isLoaded && user?.publicMetadata?.theme) {
      const savedTheme = user.publicMetadata.theme as any;
      hydrateFromMetadata(savedTheme);
    }
  }, [isLoaded, user, hydrateFromMetadata]);

  // ✅ Split fonts dynamically — 70% for free, 100% for premium
  const availableFonts = useMemo(() => {
    const freeLimit = Math.ceil(importedFonts.length * 0.7);
    return isPremium ? importedFonts : importedFonts.slice(0, freeLimit);
  }, [isPremium]);

  // ✅ Save preferences to Clerk (premium only)
  const handleSave = async () => {
    if (!isPremium || !user) return;
    try {
      await user.update({
        publicMetadata: {
          ...user.publicMetadata,
          theme: {
            backgroundColor,
            textColor,
            accentColor,
            fontFamily,
            padding,
            spacing,
          },
        },
      });
      alert('✅ Preferences saved successfully!');
    } catch (err) {
      console.error('❌ Failed to save preferences', err);
    }
  };

  return (
    <motion.aside
      initial={{ x: '100%' }}
      animate={{ x: 0 }}
      exit={{ x: '100%' }}
      transition={{ type: 'spring', damping: 25, stiffness: 180 }}
      className="fixed top-0 right-0 h-full w-96 bg-[#11111a]/90 backdrop-blur-xl border-l border-white/10 p-6 z-50 text-white flex flex-col"
    >
      {/* HEADER */}
      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-semibold text-[#b78bfa]">
          {isPremium ? 'Full Editor Access' : 'Free Editor (70%)'}
        </h2>
        <button onClick={onClose} className="p-2 hover:bg-white/10 rounded-md">
          <X size={22} />
        </button>
      </div>

      {/* EDIT OPTIONS */}
      <div className="flex flex-col gap-4 overflow-y-auto pr-2">
        {/* Background Color */}
        <div>
          <label className="block text-sm mb-1">Background Color</label>
          <input
            type="color"
            value={backgroundColor}
            onChange={(e) => setBackgroundColor(e.target.value)}
            className="w-full h-10 border border-white/20 bg-transparent rounded"
          />
        </div>

        {/* Text Color */}
        <div>
          <label className="block text-sm mb-1">Text Color</label>
          <input
            type="color"
            value={textColor}
            onChange={(e) => setTextColor(e.target.value)}
            className="w-full h-10 border border-white/20 bg-transparent rounded"
          />
        </div>

        {/* Accent Color */}
        {isPremium && (
          <div>
            <label className="block text-sm mb-1">Accent Color</label>
            <input
              type="color"
              value={accentColor}
              onChange={(e) => setAccentColor(e.target.value)}
              className="w-full h-10 border border-white/20 bg-transparent rounded"
            />
          </div>
        )}

        {/* Font Family */}
        <div>
          <label className="block text-sm mb-1">Font Family</label>
          <select
            value={fontFamily}
            onChange={(e) => setFontFamily(e.target.value)}
            className="w-full bg-transparent border border-white/20 p-2 rounded"
          >
            {availableFonts.map((f) => (
              <option key={f} value={f}>
                {f}
              </option>
            ))}
          </select>
          {!isPremium && (
            <p className="text-xs text-gray-400 mt-1">
              Upgrade to unlock full font library.
            </p>
          )}
        </div>

        {/* Padding */}
        <div>
          <label className="block text-sm mb-1">Padding</label>
          <input
            type="range"
            min="0"
            max={isPremium ? '64' : '24'}
            value={padding}
            onChange={(e) => setPadding(Number(e.target.value))}
            className="w-full"
          />
        </div>

        {/* Spacing */}
        <div>
          <label className="block text-sm mb-1">Spacing</label>
          <input
            type="range"
            min="0"
            max={isPremium ? '64' : '20'}
            value={spacing}
            onChange={(e) => setSpacing(Number(e.target.value))}
            className="w-full"
          />
        </div>

        {/* SAVE BUTTON (Premium only) */}
        {isPremium && (
          <button
            onClick={handleSave}
            className="bg-[#b78bfa] hover:bg-[#9b6efc] transition mt-4 py-2 rounded"
          >
            Save Preferences
          </button>
        )}
      </div>

      {/* FOOTER */}
      {!isPremium && (
        <p className="text-xs text-gray-500 mt-6 text-center">
          Upgrade to unlock full editor controls & permanent saves.
        </p>
      )}
    </motion.aside>
  );
}